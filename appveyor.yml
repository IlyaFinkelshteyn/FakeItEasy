version: '{build}'
image: Visual Studio 2017

pull_requests:
  do_not_increment_build_number: true

init:
- ps: >-
    if ($env:APPVEYOR_REPO_TAG_NAME) {
        $headers = @{
          "Authorization" = "Bearer $env:GITHUB_TOKEN"
          "Content-type" = "application/json"
        }
        $releases = Invoke-RestMethod -Uri "https://api.github.com/repos/$env:APPVEYOR_REPO_NAME/releases" -Headers $headers  -Method GET
        $env:releaseDescription = ($releases | Where-Object {$_.name -eq "$env:APPVEYOR_REPO_TAG_NAME"}).body
        if ($env:APPVEYOR_REPO_TAG_NAME -like "-") {
            $env:isPrerelease = "true"
        } else {
            $env:isPrerelease = "false"
        }
        echo ("isPrerelease: " + $env:isPrerelease)
        echo ("description: " + $env:releaseDescription)
    }

environment:
    BUILD: $(APPVEYOR_BUILD_NUMBER)
    GITHUB_TOKEN:
        secure: 2zhgqV68EAQ0Q4OTZlb0SZz8n6MIusGZ/cId8LlsG7vFFRJbxZAwTPriwd1U0Tmm

build_script:
- cmd: build.cmd pack

nuget:
    disable_publish_on_pr: true

test: off

artifacts:
    - path: .\artifacts\*\*

deploy:
    - provider: GitHub
      auth_token: $(GITHUB_TOKEN)
      artifact: /.*\.nupkg/
      draft: true
      force_update: true
      prerelease: $(isPrerelease)
      description: $(releaseDescription)
      on:
         appveyor_repo_tag: true
